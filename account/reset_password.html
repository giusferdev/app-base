<!DOCTYPE html>
<html lang="it">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Nuova password</title>
    <meta name="description" content="Imposta una nuova password per il tuo account.">

    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <!-- Icone -->
    <link rel="apple-touch-icon" sizes="180x180" href="../img/icon-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../img/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../img/icon-512.png">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/notte_giorno.css">
    <link rel="stylesheet" href="../css/account.css">
    <link rel="stylesheet" href="../css/settings.css">
    <link rel="stylesheet" href="../css/dashboard.css">

    <!-- JS GLOBALI -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/theme.js"></script>

</head>

<body class="light fade-in">

<div id="toast" class="toast"></div>

<header class="app-header">
    <h1>Nuova Password</h1>
</header>

<div class="login-container slide-up">
    <h2 class="title-ios">Imposta una nuova password</h2>
    <p class="subtitle">Assicurati che sia sicura e facile da ricordare.</p>

    <div id="errorBox" class="error-box" style="display:none;"></div>
    <div id="successBox" class="info-box" style="display:none;"></div>

    <div class="login-form">

        <div class="input-box password-box">
            <input type="password" id="newPassword" placeholder="Nuova password" required>
            <svg class="toggle-eye" data-target="newPassword" viewBox="0 0 24 24">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"
                      fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </div>

        <div class="input-box password-box">
            <input type="password" id="newPassword2" placeholder="Conferma password" required>
            <svg class="toggle-eye" data-target="newPassword2" viewBox="0 0 24 24">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"
                      fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </div>

    </div>

    <button id="resetBtn" class="btn-primary">Salva nuova password</button>
</div>

<script>
function showToast(message) {
    const toast = document.getElementById("toast");
    if (!toast) return;
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2000);
}

document.addEventListener("DOMContentLoaded", async () => {

    // 1ï¸âƒ£ Leggi token da Supabase (fragment)
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);

    const accessToken = params.get("access_token");
    const refreshToken = params.get("refresh_token");

    if (!accessToken) {
        document.getElementById("errorBox").style.display = "block";
        document.getElementById("errorBox").textContent =
            "Link non valido o scaduto. Richiedi un nuovo reset.";
        return;
    }

    // 2ï¸âƒ£ Imposta sessione Supabase
    await sb.auth.setSession({
        access_token: accessToken,
        refresh_token: refreshToken
    });

    // 3ï¸âƒ£ Verifica sessione
    const { data: { session }, error: sessionError } = await sb.auth.getSession();

    if (!session || sessionError) {
        document.getElementById("errorBox").style.display = "block";
        document.getElementById("errorBox").textContent =
            "Sessione non valida. Richiedi un nuovo reset.";
        return;
    }

    // 4ï¸âƒ£ Gestione click
    document.getElementById("resetBtn").addEventListener("click", async () => {

        const pass1 = document.getElementById("newPassword").value.trim();
        const pass2 = document.getElementById("newPassword2").value.trim();

        const errorBox = document.getElementById("errorBox");
        const successBox = document.getElementById("successBox");

        errorBox.style.display = "none";
        successBox.style.display = "none";

        if (!pass1 || !pass2) {
            errorBox.style.display = "block";
            errorBox.textContent = "Inserisci entrambe le password";
            return;
        }

        if (pass1 !== pass2) {
            errorBox.style.display = "block";
            errorBox.textContent = "Le password non coincidono";
            return;
        }

        // 5ï¸âƒ£ Aggiorna password
        const { error: updateError } = await sb.auth.updateUser({
            password: pass1
        });

        if (updateError) {
            errorBox.style.display = "block";
            errorBox.textContent = "Errore: " + updateError.message;
            return;
        }

        // 6ï¸âƒ£ Successo
        successBox.style.display = "block";
        successBox.textContent = "Password aggiornata con successo";

        showToast("Password aggiornata!");

        setTimeout(() => {
            window.location.href = "../index.html";
        }, 1500);
    });
});

// ðŸ‘ï¸ Toggle password visibility
document.querySelectorAll(".toggle-eye").forEach(eye => {
    eye.addEventListener("click", () => {
        const input = document.getElementById(eye.dataset.target);
        input.type = input.type === "password" ? "text" : "password";
        eye.style.opacity = input.type === "text" ? "1" : "0.6";
    });
});
</script>

</body>
</html>
