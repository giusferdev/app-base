<!DOCTYPE html>
<html lang="it">

<head>

    <!-- META BASE -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Password dimenticata</title>
    <meta name="description" content="Recupera la tua password inserendo la tua email.">

    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MyApp">

    <!-- Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <!-- Icone -->
    <link rel="apple-touch-icon" sizes="180x180" href="../img/icon-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../img/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../img/icon-512.png">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/style.css?v=1.0 (31)">
    <link rel="stylesheet" href="../css/notte_giorno.css?v=1.0 (31)">
    <link rel="stylesheet" href="../css/account.css?v=1.0 (31)">
    <link rel="stylesheet" href="../css/settings.css?v=1.0 (31)">
    <link rel="stylesheet" href="../css/dashboard.css?v=1.0 (31)">

    <!-- JS GLOBALI -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/theme.js"></script>

</head>

<body class="light fade-in">

<div id="toast" class="toast"></div>

<header class="app-header">
    <button id="backBtn" class="back-btn">‚Üê</button>
    <h1>Password dimenticata</h1>
</header>

<div class="login-container slide-up">
    <h2 class="title-ios">Recupera la password</h2>
    <p class="subtitle">Inserisci la tua email per ricevere un codice di verifica.</p>

    <div id="errorBox" class="error-box" style="display:none;"></div>
    <div id="infoBox" class="info-box" style="display:none;"></div>

    <form class="login-form">

        <div class="input-box">
            <svg class="icon-input" viewBox="0 0 24 24">
                <path d="M4 4h16v16H4z" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M4 8l8 5 8-5" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
            <input type="email" id="resetEmail" placeholder="Email" required>
        </div>

        <input type="hidden" id="csrfToken">

        <button type="button" id="sendResetBtn" class="btn-primary">Invia codice</button>
    </form>
</div>

<script>
function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
}

document.addEventListener("DOMContentLoaded", () => {

    document.getElementById("backBtn").addEventListener("click", () => {
        window.location.href = "../index.html";
    });

    const sendBtn = document.getElementById("sendResetBtn");
    const errorBox = document.getElementById("errorBox");
    const infoBox = document.getElementById("infoBox");

    sendBtn.addEventListener("click", async () => {

        const email = document.getElementById("resetEmail").value.trim();

        errorBox.style.display = "none";
        infoBox.style.display = "none";

        if (!email) {
            errorBox.style.display = "block";
            errorBox.textContent = "Inserisci la tua email";
            return;
        }

        // üî• CHIAMATA REALE A SUPABASE ‚Äî VERSIONE CORRETTA
        const { error } = await sb.auth.resetPasswordForEmail(email, {
            redirectTo: "https://giusferdev.github.io/app-base/account/reset_password.html"
        });

        if (error) {
            errorBox.style.display = "block";
            errorBox.textContent = "Errore: " + error.message;
            return;
        }

        // üî• SUCCESSO ‚Üí sostituisce la pagina corrente
        window.location.replace("forgot_password_sent.html");
    });
});
</script>

</body>
</html>
