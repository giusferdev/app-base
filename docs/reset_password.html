<!DOCTYPE html>
<html>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const sb = window.supabase.createClient("https://FQRFGGRCBFKJWVAHHWPF.supabase.co", "PUBLIC_ANON_KEY");

    // Supabase recovery mette il token NEL FRAGMENT: #access_token=...
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const accessToken = params.get("access_token");

    if (!accessToken) {
      document.body.innerHTML = "<h2>Link non valido o scaduto</h2>";
    } else {
      // Imposta la sessione
      sb.auth.setSession({
        access_token: accessToken,
        refresh_token: accessToken
      }).then(() => {
        // Mostra un form per nuova password
        document.body.innerHTML = `
          <h2>Imposta una nuova password</h2>
          <input type="password" id="p1" placeholder="Nuova password"><br>
          <input type="password" id="p2" placeholder="Conferma password"><br>
          <button id="save">Salva</button>
          <div id="msg"></div>
        `;

        document.getElementById("save").onclick = async () => {
          const p1 = document.getElementById("p1").value.trim();
          const p2 = document.getElementById("p2").value.trim();
          const msg = document.getElementById("msg");

          if (!p1 || !p2 || p1 !== p2) {
            msg.textContent = "Controlla le password";
            return;
          }

          const { error } = await sb.auth.updateUser({ password: p1 });
          if (error) {
            msg.textContent = "Errore: " + error.message;
          } else {
            msg.textContent = "Password aggiornata. Ora puoi chiudere questa pagina e riaprire l'app.";
          }
        };
      });
    }
  </script>
</body>
</html>
