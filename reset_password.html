<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reimposta Password</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { display: block; margin: 10px 0; padding: 10px; width: 100%; max-width: 300px; }
    button { padding: 10px 20px; }
    #msg { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>

<h2>Reimposta la tua password</h2>
<div id="content">Caricamento...</div>

<script>
  // CREA CLIENT SUPABASE
  const supabase = window.supabase.createClient(
    "https://fqrfggrcbfkjwvahhwpf.supabase.co",
    "PUBLIC_ANON_KEY"
  );

  // Supabase manda access_token e refresh_token nel FRAGMENT (#)
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);

  const accessToken = params.get("access_token");
  const refreshToken = params.get("refresh_token");

  const content = document.getElementById("content");

  // Se non c'è il token → link non valido
  if (!accessToken) {
    content.innerHTML = "<p>Link non valido o scaduto.</p>";
  } else {
    // Imposta la sessione con il token ricevuto
    supabase.auth.setSession({
      access_token: accessToken,
      refresh_token: refreshToken
    }).then(() => {
      // Mostra form per nuova password
      content.innerHTML = `
        <input type="password" id="p1" placeholder="Nuova password" />
        <input type="password" id="p2" placeholder="Conferma password" />
        <button id="save">Salva nuova password</button>
        <div id="msg"></div>
      `;

      document.getElementById("save").onclick = async () => {
        const p1 = document.getElementById("p1").value.trim();
        const p2 = document.getElementById("p2").value.trim();
        const msg = document.getElementById("msg");

        if (!p1 || !p2) {
          msg.textContent = "Inserisci entrambe le password.";
          return;
        }
        if (p1 !== p2) {
          msg.textContent = "Le password non coincidono.";
          return;
        }

        const { error } = await supabase.auth.updateUser({ password: p1 });

        if (error) {
          msg.textContent = "Errore: " + error.message;
        } else {
          msg.textContent = "Password aggiornata! Ora puoi chiudere questa pagina.";
        }
      };
    });
  }
</script>

</body>
</html>
